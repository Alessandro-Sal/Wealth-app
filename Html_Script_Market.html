<script>
/**
 * ======================================================================================
 * BLOCK 5: MARKET, WATCHLIST & INVESTMENTS
 * Handles Live Portfolio updates, Watchlist management, TradingView widgets, and Analytics.
 * ======================================================================================
 */

// --- Live Portfolio ---

/**
 * Fetches real-time portfolio data from the server.
 * Triggers skeleton loading states before rendering.
 */
function fetchLivePortfolio() {
  showSkeleton('live-stocks', 3, '70px', true);
  showSkeleton('live-etfs', 3, '70px', true);
  showSkeleton('live-crypto', 3, '70px', true);
  google.script.run.withSuccessHandler(renderLivePortfolio).getLivePortfolio();
}

/**
 * Renders the Live Portfolio dashboard cards (Stocks, ETFs, Crypto).
 * Calculates daily change percentages and market status (Open/Closed).
 * 
 */
function renderLivePortfolio(data) {
  // Render Global Day Change Widget
  const dcContainer = document.getElementById('live-day-change');
  if (dcContainer && data.dayChange) {
      const val = data.dayChange.val; 
      const pct = data.dayChange.pct; 
      const isNeg = val.includes('-') || pct.includes('-');
      
      const colorStyle = isNeg ? 'color:var(--danger);' : 'color:var(--stocks-bg);'; 
      const bgStyle = isNeg ? 'background:rgba(255, 59, 48, 0.1);' : 'background:rgba(40, 167, 69, 0.1);';
      
      dcContainer.innerHTML = `<div style="background:var(--white); border-radius:12px; padding:12px; margin: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; align-items:center; gap:10px;"><div style="width:40px; height:40px; border-radius:50%; ${bgStyle} display:flex; align-items:center; justify-content:center; font-size:20px;">${(isNeg ? 'üìâ' : 'üìà')}</div><div><div style="font-size:12px; font-weight:600; color:var(--gray); text-transform:uppercase;">Day Change</div><div class="sensitive" style="font-size:18px; font-weight:800; color:var(--text-main);">${val}</div></div></div><div style="font-size:14px; font-weight:700; ${colorStyle} padding:4px 8px; border-radius:6px; ${bgStyle}">${pct}</div></div>`;
  }

  // Helper to create individual Ticker Cards
  const createTickerCard = (item, type, index) => {
      const isCrypto = (type === 'crypto'); 
      let pctHtml = '';
      
      if (item.pct) { 
          let rawPct = String(item.pct).replace('%', '').trim().replace(',', '.'); 
          let floatPct = parseFloat(rawPct); 
          let badgeClass = floatPct >= 0 ? 'pos-change' : 'neg-change'; 
          pctHtml = '<span class="tc-change ' + badgeClass + '">' + item.pct + '</span>'; 
      }
      
      let dayChangeHtml = ''; 
      if (item.dCh) { 
          let rawDCh = String(item.dCh).replace(/[‚Ç¨$%]/g, '').trim().replace(',', '.'); 
          let floatDCh = parseFloat(rawDCh); 
          let color = floatDCh >= 0 ? '#34c759' : '#ff3b30'; 
          let sign = floatDCh > 0 ? '+' : ''; 
          dayChangeHtml = '<div class="sensitive" style="font-size:10px; font-weight:600; color:' + color + '; margin-top:2px;">' + sign + item.dCh + ' (24h)</div>'; 
      }
      
      // Market Status Indicator
      let borderStyle = 'border-left: 2px solid #e5e5ea;'; 
      let opacityStyle = 'opacity: 0.6; filter: grayscale(0.2);'; 
      let statusIcon = '';
      
      if (isCrypto) { 
          borderStyle = 'border-left: 4px solid #ffc107;'; 
          opacityStyle = 'opacity: 1;'; 
      } else { 
          const state = getMarketState(item.ex); 
          if (state === 'OPEN') { 
              borderStyle = 'border-left: 4px solid #34c759;'; 
              opacityStyle = 'opacity: 1;'; 
          } else if (state === 'CLOSING_SOON') { 
              borderStyle = 'border-left: 4px solid #ff9500;'; 
              opacityStyle = 'opacity: 1;'; 
              statusIcon = '<span style="font-size:8px; margin-left:4px;">üü†</span>'; 
          } else if (state === 'PRE_MARKET') { 
              borderStyle = 'border-left: 4px solid #007aff;'; 
              opacityStyle = 'opacity: 0.9;'; 
              statusIcon = '<span style="font-size:8px; margin-left:4px;">üîµ</span>'; 
          } 
      }
      
      return `<div class="ticker-card" onclick="openPortfolioModal('${type}', ${index})" style="${borderStyle} ${opacityStyle} transition: all 0.3s ease; position:relative; cursor:pointer;"><div class="tc-top"><div style="display:flex; align-items:center;"><span class="tc-symbol">${item.t}</span>${statusIcon}</div>${pctHtml}</div><div class="tc-val-big" style="font-weight:800; line-height:1.1;">${item.price}</div>${dayChangeHtml}<div class="tc-val-sub sensitive" style="margin-top:4px;">Tot: ${item.val}</div></div>`;
  };

  const renderCont = (id, list, type) => {
      const c = document.getElementById(id); 
      if(!c) return;
      if (list && list.length > 0) {
          let sorted = list; 
          if(typeof sortTickerData === 'function') sorted = sortTickerData(list);
          currentPortfolioData[type] = sorted;
          c.innerHTML = sorted.map((item, i) => createTickerCard(item, type, i)).join('');
      } else { 
          c.innerHTML = '<div style="padding:10px; font-size:12px;">No data</div>'; 
      }
  };

  renderCont('live-stocks', data.stocks, 'stocks');
  renderCont('live-etfs', data.etfs, 'etfs');
  renderCont('live-crypto', data.crypto, 'crypto');
}

// --- Watchlist Management ---

function fetchWatchlist() {
  const cont = document.getElementById('watchlist-container'); if (!cont) return;
  let list = document.getElementById('wl-list');
  
  if (!list) { 
      cont.innerHTML = ''; 
      list = document.createElement('div'); 
      list.id = 'wl-list'; 
      cont.appendChild(list); 
  }
  
  // Horizontal Scroll Layout
  list.style.cssText = `display: flex !important; overflow-x: auto !important; gap: 10px !important; padding: 10px !important; width: 100% !important; box-sizing: border-box !important; list-style: none !important; -webkit-overflow-scrolling: touch;`;
  list.innerHTML = '<div style="grid-column: 1/-1; padding:20px; text-align:center; color:#888; font-size:12px;">Loading watchlist...</div>';
  
  google.script.run.withSuccessHandler(function(data) { 
      myWatchlistData = data; 
      renderWatchlist(); 
  }).withFailureHandler(function(err) { 
      const listEl = document.getElementById('wl-list'); 
      if(listEl) listEl.innerHTML = `<div style="grid-column: 1/-1; color:red; text-align:center; padding:10px;">Error: ${err.message}</div>`; 
  }).getWatchlistData();
}

function renderWatchlist() {
  const list = document.getElementById('wl-list');
  const loader = document.getElementById('wl-loader') || document.getElementById('loader');
  if (loader) loader.style.display = 'none';
  if (!list) return;
  
  if (!myWatchlistData || myWatchlistData.length === 0) { 
      list.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:#999; font-size:14px;">Watchlist is empty.<br>Use the + button to add tickers.</div>'; 
      return; 
  }
  
  const htmlContent = myWatchlistData.map((item, index) => {
      const valPct = item.dayPct || item.pct || "0%"; 
      const ticker = item.ticker || item.t || "---"; 
      const price = item.price || "-"; 
      const desc = item.desc || item.name || "Stock"; 
      const currency = item.curr || "EUR";
      
      let simulatedExchange = 'US'; 
      if (currency === 'EUR') simulatedExchange = 'IT'; 
      if (currency === 'GBP') simulatedExchange = 'UK';
      
      let state = 'OPEN'; 
      if (typeof getMarketState === 'function') state = getMarketState(simulatedExchange);
      
      let borderStyle = 'border-left: 4px solid #34c759;'; 
      let opacityStyle = ''; 
      let statusIcon = '';
      
      if (state === 'CLOSING_SOON') { 
          borderStyle = 'border-left: 4px solid #ff9500;'; 
          statusIcon = '<span style="font-size:8px; margin-left:4px;">üü†</span>'; 
      } else if (state === 'PRE_MARKET') { 
          borderStyle = 'border-left: 4px solid #007aff;'; 
          opacityStyle = 'opacity: 0.9;'; 
          statusIcon = '<span style="font-size:8px; margin-left:4px;">üîµ</span>'; 
      } else if (state === 'CLOSED') { 
          borderStyle = 'border-left: 2px solid #e5e5ea;'; 
          opacityStyle = 'opacity: 0.6; filter: grayscale(0.2);'; 
      }
      
      let badgeClass = 'neutral-change'; 
      let floatPct = parseFloat(String(valPct).replace('%', '').replace(',', '.')); 
      if (!isNaN(floatPct)) badgeClass = floatPct >= 0 ? 'pos-change' : 'neg-change';
      let pctHtml = '<span class="tc-change ' + badgeClass + '">' + valPct + '</span>';
      
      return `<div class="ticker-card" onclick="openWlModal(${index})" style="${borderStyle} ${opacityStyle} cursor:pointer; position:relative; background:var(--card-bg, #fff); min-height:80px; margin:0;"><div class="tc-top"><div style="display:flex; align-items:center;"><span class="tc-symbol">${ticker}</span>${statusIcon}</div>${pctHtml}</div><div class="tc-val-big" style="font-weight:800; line-height:1.1;">${price}</div><div class="sensitive" style="font-size:10px; color:#888; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${desc}</div></div>`;
  }).join('');
  list.innerHTML = htmlContent;
}

// --- Watchlist Modal Logic ---

function openWlModal(index) {
  const item = myWatchlistData[index]; 
  if (!item) return;
  
  window.currentWlIndex = index; 
  const modal = document.getElementById('wl-modal');
  const delBtn = document.getElementById('wl-btn-del');
  
  if(delBtn) { 
      delBtn.style.display = 'flex'; 
      delBtn.onclick = function() { deleteFromWatchlist(item.row, item.ticker); }; 
  }
  
  const externalName = document.getElementById('wl-mod-name'); 
  if(externalName) externalName.style.display = 'none';
  
  const tickerEl = document.getElementById('wl-mod-ticker'); 
  tickerEl.innerHTML = item.ticker + '<br><span style="font-size:14px; font-weight:normal; opacity:0.8;">' + (item.name || 'Stock') + '</span>';
  
  // Price & Conversion Logic
  let cleanPriceStr = String(item.price).replace(/[^\d.,-]/g, ''); 
  if (cleanPriceStr.indexOf(',') > -1 && cleanPriceStr.indexOf('.') === -1) cleanPriceStr = cleanPriceStr.replace(',', '.'); 
  else if (cleanPriceStr.indexOf(',') > -1 && cleanPriceStr.indexOf('.') > -1) cleanPriceStr = cleanPriceStr.replace(/\./g, '').replace(',', '.');
  
  let rawPrice = parseFloat(cleanPriceStr) || 0; 
  let rate = parseFloat(item.rate) || 1.08; 
  let isUsd = (item.curr === 'USD' || String(item.price).includes('$')); 
  let isGbp = (item.curr === 'GBP' || String(item.price).includes('¬£')); 
  let symbol = isUsd ? '$' : (isGbp ? '¬£' : '‚Ç¨');
  
  document.getElementById('wl-mod-price-main').innerText = symbol + " " + new Intl.NumberFormat('en-US', {minimumFractionDigits: 2}).format(rawPrice);
  
  const lblConv = document.getElementById('wl-mod-lbl-conv'); 
  const valConv = document.getElementById('wl-mod-price-conv'); 
  valConv.classList.remove('sensitive');
  
  if (isUsd || isGbp) { 
      let eurVal = rawPrice / rate; 
      lblConv.innerText = "Value in ‚Ç¨"; 
      valConv.innerText = "‚Ç¨ " + new Intl.NumberFormat('it-IT', {minimumFractionDigits: 2}).format(eurVal); 
      valConv.style.color = "#007aff"; 
      valConv.style.fontWeight = "bold"; 
  } else { 
      lblConv.innerText = "Price EUR"; 
      valConv.innerText = symbol + " " + new Intl.NumberFormat('it-IT', {minimumFractionDigits: 2}).format(rawPrice); 
      valConv.style.color = "var(--text-main)"; 
  }
  
  // Advanced Stats
  const fmtBig = (val) => { 
      if (!val || val === "0" || val === "-") return "-"; 
      let n = parseFloat(String(val).replace(/,/g,'')); 
      if (isNaN(n)) return val; 
      if (n > 1e12) return (n/1e12).toFixed(2) + "T"; 
      if (n > 1e9) return (n/1e9).toFixed(2) + "B"; 
      if (n > 1e6) return (n/1e6).toFixed(2) + "M"; 
      return n.toFixed(2); 
  };
  
  const setText = (id, txt) => { 
      const el = document.getElementById(id); 
      if(el) el.innerText = (txt && txt !== "" && txt !== "#N/A" && txt !== "0") ? txt : "-"; 
  };
  
  setText('wl-mod-pe', item.pe); 
  setText('wl-mod-eps', item.eps); 
  document.getElementById('wl-mod-mkt').innerText = fmtBig(item.mkt); 
  setText('wl-mod-beta', item.beta); 
  setText('wl-mod-52h', item.yearH); 
  setText('wl-mod-52l', item.yearL);
  
  if(typeof renderChartWidget === 'function') renderChartWidget(item.ticker);
        const siteLink = document.getElementById('wl-link-site');
        const googleLink = document.getElementById('wl-link-google');
          
          if (siteLink) {
          siteLink.href = 'https://www.google.com/search?q=' + encodeURIComponent((item.name || item.ticker) + ' IR');
          }
          if (googleLink) {
          googleLink.href = 'https://www.google.com/finance?q=' + encodeURIComponent(item.ticker);
          }
  
  // 52-Week Range Bar
  const rangeContainer = document.getElementById('wl-range-container');
  const parseNum = (v) => { if(!v || v === "-" || v === "0" || v === "" || v === "N/A") return null; let s = String(v).replace(/[^\d.,-]/g, ''); if (s.indexOf(',') > -1) { s = s.replace(/\./g, ''); s = s.replace(',', '.'); } let n = parseFloat(s); return isNaN(n) ? null : n; };
  
  let currentP = parseNum(item.price); 
  let low52 = parseNum(item.yearL); 
  let high52 = parseNum(item.yearH);
  
  if (currentP !== null && low52 !== null && high52 !== null && high52 > low52) {
      let pct = ((currentP - low52) / (high52 - low52)) * 100; 
      pct = Math.max(0, Math.min(100, pct));
      
      const dot = document.getElementById('wl-range-dot'); 
      if(dot) { 
          dot.style.left = pct + "%"; 
          dot.style.background = pct > 80 ? "#34c759" : (pct < 20 ? "#ff3b30" : "#007AFF"); 
      }
      document.getElementById('wl-range-min').innerText = item.yearL; 
      document.getElementById('wl-range-max').innerText = item.yearH; 
      rangeContainer.style.display = 'block';
  } else { 
      rangeContainer.style.display = 'none'; 
  }
  
  modal.style.display = 'flex';
}

function openPortfolioModal(type, index) {
  try {
      const item = currentPortfolioData[type][index]; 
      if (!item) return;
      
      const modal = document.getElementById('wl-modal');
      const delBtn = document.getElementById('wl-btn-del'); 
      if(delBtn) delBtn.style.display = 'none'; // Hide delete button for portfolio items
      
      const setText = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = (txt && txt !== "" && txt !== "#N/A" && txt !== "0") ? txt : "-"; };
      
      const tickerEl = document.getElementById('wl-mod-ticker'); 
      const fullName = item.name && item.name !== "#N/A" ? item.name : item.t; 
      if(tickerEl) tickerEl.innerHTML = item.t + '<br><span style="font-size:14px; font-weight:normal; opacity:0.8;">' + fullName + '</span>';
      
      let symbol = "‚Ç¨"; 
      let currCode = item.curr ? String(item.curr).trim().toUpperCase() : ""; 
      if (currCode === "USD" || currCode === "US DOLLAR") symbol = "$"; 
      else if (currCode === "GBP") symbol = "¬£"; 
      if (symbol === "‚Ç¨" && item.price) { if (item.price.includes("$")) symbol = "$"; if (item.price.includes("¬£")) symbol = "¬£"; }
      
      let cleanPrice = String(item.price).replace(/[^0-9.,-]/g, '').trim(); 
      document.getElementById('wl-mod-price-main').innerText = symbol + " " + cleanPrice;
      
      const lblConv = document.getElementById('wl-mod-lbl-conv'); 
      if(lblConv) lblConv.innerText = "Current Value";
      
      const valContainer = document.getElementById('wl-mod-price-conv'); 
      if(valContainer) { 
          let cleanVal = String(item.val).replace(/[^0-9.,-]/g, '').trim(); 
          valContainer.innerText = "‚Ç¨ " + cleanVal; 
          valContainer.classList.add('sensitive'); 
          valContainer.style.color = "var(--text-main)"; 
      }
      
      setText('wl-mod-pe', item.pe); 
      setText('wl-mod-eps', item.eps); 
      setText('wl-mod-beta', item.beta); 
      setText('wl-mod-mkt', item.mkt); 
      setText('wl-mod-vol', item.vol); 
      setText('wl-mod-dh', item.dayH); 
      setText('wl-mod-dl', item.dayL); 
      setText('wl-mod-52h', item.yearH); 
      setText('wl-mod-52l', item.yearL); 
      setText('wl-mod-sector', item.sector); 
      setText('wl-mod-ind', item.ind); 
      setText('wl-mod-ctry', item.ctry); 
      setText('wl-mod-curr', item.curr);

       const linkSite = document.getElementById('wl-link-site');
          if(linkSite) linkSite.href = 'https://www.google.com/search?q=' + encodeURIComponent(fullName + ' IR');
          
          const linkGoogle = document.getElementById('wl-link-google');
          if(linkGoogle) linkGoogle.href = 'https://www.google.com/finance?q=' + item.t;
      
      if(typeof renderChartWidget === 'function') renderChartWidget(item.t);
      
      modal.style.display = 'flex';
  } catch(e) { console.error("Error opening portfolio modal:", e); }
}

function closeWlModal() { document.getElementById('wl-modal').style.display = 'none'; }

/**
 * Embeds a TradingView Mini Chart Widget dynamically.
 * 
 */
function renderChartWidget(ticker) {
  var chartContainer = document.getElementById('wl-chart-wrapper');
  chartContainer.innerHTML = ""; 
  
  var widgetDiv = document.createElement('div'); 
  widgetDiv.className = "tradingview-widget-container"; 
  widgetDiv.style.height = "100%"; 
  widgetDiv.style.width = "100%";
  
  var innerDiv = document.createElement('div'); 
  innerDiv.className = "tradingview-widget-container__widget"; 
  innerDiv.style.height = "100%"; 
  innerDiv.style.width = "100%"; 
  widgetDiv.appendChild(innerDiv);
  
  setTimeout(() => {
      var script = document.createElement('script'); 
      script.type = 'text/javascript'; 
      script.async = true; 
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
      
      script.innerHTML = JSON.stringify({ 
          "symbols": [[ticker, ticker]], 
          "chartOnly": false, 
          "width": "100%", 
          "height": "100%", 
          "locale": "en", 
          "colorTheme": document.body.classList.contains('dark-mode') ? "dark" : "light", 
          "autosize": true, 
          "showVolume": false, 
          "hideDateRanges": false, 
          "scalePosition": "right", 
          "scaleMode": "Normal", 
          "valuesTracking": "1", 
          "chartType": "area", 
          "lineColor": "#2962FF", 
          "bottomColor": "rgba(41, 98, 255, 0)", 
          "topColor": "rgba(41, 98, 255, 0.3)" 
      });
      
      widgetDiv.appendChild(script); 
      chartContainer.appendChild(widgetDiv);
  }, 300);
}

// --- Analytics Chart Rendering (Portfolio Analysis) ---

function fetchAnalyticsData() {
  google.script.run.withSuccessHandler(data => {
      analyticsDataCache = data;
      const container = document.getElementById('chartContainer');
      if (!document.getElementById('analyticsChart') && container) { 
          container.innerHTML = '<canvas id="analyticsChart"></canvas>'; 
      }
      updateAnalyticsChart();
  }).getAnalyticsData();
}

function updateAnalyticsChart() {
  if (!analyticsDataCache) return;
  const ctxEl = document.getElementById('analyticsChart'); 
  if (!ctxEl) return;
  const ctx = ctxEl.getContext('2d');
  
  const assetType = document.getElementById('assetSelect').value; 
  const chartType = document.getElementById('chartSelect').value; 
  
  let dataset = [];
  if (assetType === 'combined') { 
      const s = analyticsDataCache['stocks'] || []; 
      const e = analyticsDataCache['etfs'] || []; 
      dataset = [...s, ...e]; 
  } else { 
      dataset = analyticsDataCache[assetType] || []; 
  }
  
  // Calculation preprocessing
  dataset = dataset.map(item => { 
      let invested = item.value - item.gainEur; 
      let tradeRealized = item.realizedExcl || 0; 
      let divs = item.dividends || 0; 
      let cashRealized = tradeRealized + divs; 
      let totalGain = item.gainEur + cashRealized; 
      return { ...item, invested: invested, tradeRealized: tradeRealized, cashRealized: cashRealized, totalGain: totalGain }; 
  });
  
  // Filter Logic
  if (['realized_excl', 'realized_incl', 'total_gain', 'div_single', 'winloss'].includes(chartType)) { 
      dataset = dataset.filter(item => item.value > 0.01 || Math.abs(item.totalGain) > 1 || Math.abs(item.tradeRealized) > 1); 
  } else { 
      dataset = dataset.filter(item => item.value > 0.01); 
  }
  
  let totalValue = dataset.reduce((acc, curr) => acc + curr.value, 0);
  let labels = []; 
  let values = []; 
  let colors = []; 
  let formatType = 'currency'; 
  let secondaryValues = [];
  
  const palette = ['#007aff', '#34c759', '#ff9500', '#ff2d55', '#5856d6', '#af52de', '#5ac8fa', '#ffcc00', '#8e8e93'];
  const getColors = (len) => Array.from({length: len}, (_, i) => palette[i % palette.length]);
  
  const aggregateData = (key) => { 
      let map = {}; 
      dataset.forEach(item => { 
          if (item.value < 0.01) return; 
          let k = item[key] || 'Other'; 
          if(k === '') k = 'Other'; 
          map[k] = (map[k] || 0) + item.value; 
      }); 
      let sorted = Object.entries(map).sort((a,b) => b[1] - a[1]); 
      labels = sorted.map(s => s[0]); 
      values = sorted.map(s => s[1]); 
      colors = getColors(labels.length); 
      formatType = 'currency'; 
  };
  
  switch (chartType) {
      case 'breakdown': dataset.sort((a, b) => b.value - a.value); labels = dataset.map(d => d.ticker); values = dataset.map(d => d.value); colors = getColors(dataset.length); formatType = 'currency'; break;
      case 'invested': dataset.sort((a, b) => b.invested - a.invested); labels = dataset.map(d => d.ticker); values = dataset.map(d => d.invested.toFixed(2)); colors = '#5856d6'; formatType = 'currency'; break;
      case 'performance': dataset.sort((a, b) => b.gainPct - a.gainPct); labels = dataset.map(d => d.ticker); values = dataset.map(d => (d.gainPct * 100).toFixed(2)); secondaryValues = dataset.map(d => d.gainEur); colors = values.map(v => v >= 0 ? '#34c759' : '#ff3b30'); formatType = 'percent_combo'; break;
      case 'total_gain': dataset.sort((a, b) => b.totalGain - a.totalGain); labels = dataset.map(d => d.ticker); values = dataset.map(d => d.totalGain); colors = values.map(v => v >= 0 ? '#34c759' : '#ff3b30'); formatType = 'currency'; break;
      case 'realized_excl': dataset.sort((a, b) => b.tradeRealized - a.tradeRealized); labels = dataset.map(d => d.ticker); values = dataset.map(d => d.tradeRealized); colors = values.map(v => v >= 0 ? '#34c759' : '#ff3b30'); formatType = 'currency'; break;
      case 'realized_incl': dataset.sort((a, b) => b.cashRealized - a.cashRealized); labels = dataset.map(d => d.ticker); values = dataset.map(d => d.cashRealized); colors = values.map(v => v >= 0 ? '#34c759' : '#ff3b30'); formatType = 'currency'; break;
      case 'div_single': let divSet = dataset.filter(d => d.dividends > 0).sort((a,b) => b.dividends - a.dividends); labels = divSet.map(d => d.ticker); values = divSet.map(d => d.dividends); colors = '#ffcc00'; formatType = 'currency'; break;
      case 'winloss': let win = dataset.filter(d => d.totalGain >= 0).length; let loss = dataset.filter(d => d.totalGain < 0).length; labels = ['In Profit', 'In Loss']; values = [win, loss]; colors = ['#34c759', '#ff3b30']; formatType = 'number'; break;
      default: aggregateData(chartType); break;
  }
  
  if (analyticsChartInstance) { analyticsChartInstance.destroy(); }
  const isPie = ['breakdown', 'winloss', 'sector', 'industry', 'country'].includes(chartType);
  
  analyticsChartInstance = new Chart(ctx, {
      type: isPie ? 'doughnut' : 'bar',
      data: { labels: labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 1, borderColor: document.body.classList.contains('dark-mode') ? '#1c1c1e' : '#fff' }] },
      options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
              legend: { display: isPie, position: 'right', labels: { color: document.body.classList.contains('dark-mode') ? '#fff' : '#000', font: { size: 10 }, boxWidth: 10 } },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          let label = context.label || ''; 
                          let val = Number(context.parsed.y !== undefined && !isPie ? context.parsed.y : context.parsed); 
                          const isPrivacy = document.body.classList.contains('privacy-mode'); 
                          const idx = context.dataIndex;
                          
                          if (formatType === 'percent_combo') { 
                              let eurVal = secondaryValues[idx]; 
                              let formattedEur = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(eurVal); 
                              return isPrivacy ? `${label}: ${val}% (Gain: ***)` : `${label}: ${val}% (Gain: ${formattedEur})`; 
                          }
                          
                          if (formatType === 'currency') { 
                              let suffix = ""; 
                              if ((isPie || chartType === 'invested' || chartType === 'breakdown') && totalValue > 0) { 
                                  let pct = ((val / totalValue) * 100).toFixed(1); 
                                  suffix = ` (${pct}%)`; 
                              } 
                              if (isPrivacy) return `${label}: ***${suffix}`; 
                              let formattedEur = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val); 
                              return `${label}: ${formattedEur}${suffix}`; 
                          }
                          
                          if (formatType === 'percent') return `${label}: ${val}%`; 
                          return `${label}: ${val}`;
                      }
                  }
              }
          },
          scales: { 
              x: { display: !isPie, ticks: { color: 'var(--gray)', font: {size: 9}, autoSkip: false, maxRotation: 90, minRotation: 0 }, grid: { display: false } }, 
              y: { display: !isPie, ticks: { color: 'var(--gray)', callback: function(value) { if (document.body.classList.contains('privacy-mode')) { return '****'; } if (formatType === 'percent' || formatType === 'percent_combo') { return value + '%'; } return new Intl.NumberFormat('it-IT', { notation: "compact" }).format(value); } }, grid: { color: 'rgba(128,128,128,0.1)' } } 
          }
      }
  });
}


/**
 * Market Data Polling Management.
 * Handles the cyclical update of Watchlist, Live Portfolio, and Macro Benchmarks.
 */
let marketPollInterval = null;

function startMarketPolling() {
  // 1. Safety Clear: Ensure no duplicate intervals are running
  stopMarketPolling();
  
  console.log("üü¢ Market Polling Started (30s interval)");
  
  // 2. IMMEDIATE UPDATE (Runs as soon as tab opens)
  // This ensures data is aligned instantly without waiting for the first interval tick.
  fetchWatchlist();
  fetchLivePortfolio(); 
  loadMarketInsights(false); // Quick load (Cached Macro)

  // 3. SET INTERVAL (Cyclic updates)
  marketPollInterval = setInterval(() => {
      // Safety Check: Verify user is still on the Market tab
      const marketPage = document.getElementById('p-market');
      const isVisible = marketPage && 
                        marketPage.style.display !== 'none' && 
                        !marketPage.classList.contains('hidden');

      if (isVisible) {
          console.log("üîÑ Polling Market Data...");
          
          // A. Refresh Watchlist
          fetchWatchlist();
          
          // B. Refresh Live Portfolio (Syncs your Day Change)
          fetchLivePortfolio(); 
          
          // C. Refresh Benchmarks (Syncs S&P500, VIX, etc.)
          loadMarketInsights(false); 
          
      } else {
          // If page is hidden but interval is running, stop it to save battery
          stopMarketPolling();
      }
  }, 60000); // 30 Seconds Interval
}

function stopMarketPolling() {
  if (marketPollInterval) {
      clearInterval(marketPollInterval);
      marketPollInterval = null;
      console.log("üî¥ Market Polling Stopped");
  }
}

function checkMarketStatus() {
  const statusDiv = document.getElementById('market-status'); if (!statusDiv) return;
  const now = new Date();
  
  const isTimeInWindow = (timeZone, openH, openM, closeH, closeM) => {
      try { 
          const localStr = now.toLocaleString("en-US", {timeZone: timeZone}); 
          const localDate = new Date(localStr); 
          const day = localDate.getDay(); 
          const h = localDate.getHours(); 
          const m = localDate.getMinutes(); 
          const curMins = h * 60 + m; 
          const openMins = openH * 60 + openM; 
          const closeMins = closeH * 60 + closeM; 
          // Weekdays only (1-5)
          return (day >= 1 && day <= 5 && curMins >= openMins && curMins < closeMins); 
      } catch(e) { return false; }
  };
  
  const usOpen = isTimeInWindow("America/New_York", 9, 30, 16, 0); 
  const euOpen = isTimeInWindow("Europe/Berlin", 9, 0, 17, 30); 
  const ukOpen = isTimeInWindow("Europe/London", 8, 0, 16, 30);
  
  const badge = (flag, name, isOpen) => { 
      const color = isOpen ? '#34c759' : '#8e8e93'; 
      const opacity = isOpen ? '1' : '0.5'; 
      const status = isOpen ? '' : 'üí§'; 
      return `<span style="margin-right:8px; opacity:${opacity}; font-weight:700; color:${color}; border:1px solid ${color}; padding:2px 6px; border-radius:6px; font-size:10px;">${flag} ${name} ${status}</span>`; 
  };
  statusDiv.innerHTML = `<div style="display:flex; margin-top:4px;">${badge('üá∫üá∏', 'USA', usOpen)}${badge('üá™üá∫', 'EU', euOpen)}${badge('üá¨üáß', 'UK', ukOpen)}</div>`;
}

function getMarketState(exchangeCode) {
  if (!exchangeCode || exchangeCode === 'CRYPTO') return 'OPEN';
  const now = new Date(); let timeZone = "UTC"; let openH = 9, openM = 0, closeH = 17, closeM = 0;
  
  switch (String(exchangeCode).toUpperCase()) {
      case 'US': case 'USA': case 'NASDAQ': case 'NYSE': case 'AMEX': timeZone = "America/New_York"; openH = 9; openM = 30; closeH = 16; closeM = 0; break;
      case 'IT': case 'ITA': case 'MIL': case 'MTA': case 'DE': case 'GER': case 'XETRA': case 'EU': case 'EAM': case 'TDG': case 'CPH': timeZone = "Europe/Berlin"; openH = 9; openM = 0; closeH = 17; closeM = 30; break;
      case 'UK': case 'LSE': timeZone = "Europe/London"; openH = 8; openM = 0; closeH = 16; closeM = 30; break;
      default: return 'CLOSED';
  }
  
  try {
      const localTimeStr = now.toLocaleString("en-US", {timeZone: timeZone}); const localDate = new Date(localTimeStr); const day = localDate.getDay(); const h = localDate.getHours(); const m = localDate.getMinutes();
      const curMins = h * 60 + m; const openMins = openH * 60 + openM; const closeMins = closeH * 60 + closeM;
      if (day === 0 || day === 6) return 'CLOSED';
      if (curMins >= openMins && curMins < closeMins) { if (closeMins - curMins <= 60) return 'CLOSING_SOON'; return 'OPEN'; }
      if (curMins >= (openMins - 60) && curMins < openMins) return 'PRE_MARKET';
      return 'CLOSED';
  } catch (e) { return 'CLOSED'; }
}

// Sorting logic for tickers (Open Markets First)
function sortTickerData(list) {
  const statePriority = { 'CLOSING_SOON': 1, 'OPEN': 2, 'PRE_MARKET': 3, 'CLOSED': 4 };
  return list.sort((a, b) => {
      const stateA = getMarketState(a.ex); const stateB = getMarketState(b.ex);
      const weightA = statePriority[stateA] || 5; const weightB = statePriority[stateB] || 5;
      if (weightA !== weightB) return weightA - weightB;
      const getVal = (item) => { let raw = item.dCh || item.pct || "0"; return parseFloat(String(raw).replace(/[‚Ç¨$%]/g, '').replace(',', '.').replace(/\s/g, '')); };
      return getVal(a) - getVal(b);
  });
}

function toggleWatchlistInput() {
  const box = document.getElementById('wl-add-box'); if(!box) return;
  if (box.style.display === 'none' || box.style.display === '') { 
      box.style.display = 'block'; 
      setTimeout(() => { const input = document.getElementById('wlTickerInput'); if(input) input.focus(); }, 100); 
  } else { 
      box.style.display = 'none'; 
  }
}

function sendAddToWatchlist() {
  const input = document.getElementById('wlTickerInput'); if (!input) return;
  const ticker = input.value.trim().toUpperCase(); if (!ticker) { alert("Enter a ticker"); return; }
  
  const btn = document.querySelector('#wl-add-box button'); 
  const oldText = btn ? btn.innerText : 'ADD'; 
  if (btn) { btn.innerText = "‚è≥..."; btn.disabled = true; }
  
  google.script.run.withSuccessHandler(function(response) { 
      if (btn) { btn.innerText = oldText; btn.disabled = false; } 
      input.value = ""; 
      toggleWatchlistInput(); 
      if (typeof Swal !== 'undefined') { 
          Swal.fire({ icon: 'success', title: response, toast: true, position: 'top', timer: 2000, showConfirmButton: false }); 
      } else { alert(response); } 
      fetchWatchlist(); 
  }).withFailureHandler(function(error) { 
      if (btn) { btn.innerText = oldText; btn.disabled = false; } 
      alert("Error: " + error.message); 
  }).addToWatchlist(ticker);
}

function deleteFromWatchlist(row, ticker) {
  closeWlModal(); 
  Swal.fire({ 
      title: 'Delete ' + ticker + '?', 
      text: "This will remove the ticker from your Watchlist.", 
      icon: 'warning', 
      showCancelButton: true, 
      confirmButtonColor: '#ff3b30', cancelButtonColor: '#8e8e93', 
      confirmButtonText: 'Yes, delete', cancelButtonText: 'Cancel', 
      background: '#ffffff', color: '#333', borderRadius: '20px', reverseButtons: true 
  }).then((result) => {
      if (result.isConfirmed) {
          const listEl = document.getElementById('wl-list');
          if (listEl) { listEl.innerHTML = `<div style="grid-column:1/-1; padding:40px; text-align:center; color:#888;"><div style="font-size:30px; margin-bottom:10px;">üóëÔ∏è</div><div>Deleting ${ticker}...</div></div>`; }
          
          google.script.run.withSuccessHandler(() => { 
              Swal.fire({ icon: 'success', title: 'Deleted!', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 }); 
              fetchWatchlist(); 
          }).withFailureHandler((err) => { 
              alert("Error deleting: " + err.message); 
              fetchWatchlist(); 
          }).removeFromWatchlist(row);
      }
  });
}

// --- Investment History Logic ---

function fetchInvestHistory() {
  showSkeleton('hist-stocks', 3, '50px'); 
  showSkeleton('hist-crypto', 3, '50px');
  google.script.run.withSuccessHandler(renderInvestHistory).getLastInvestments();
}

function renderInvestHistory(data) {
  const renderList = (list, containerId) => {
      const container = document.getElementById(containerId);
      if (!list || list.length === 0) { 
          container.innerHTML = '<div style="text-align:center; padding:5px; color:var(--gray); font-size:11px;">No history</div>'; 
          return; 
      }
      let html = '';
      list.forEach(tx => {
          let badgeStyle = getActionStyle(tx.action);
          html += `<div class="h-item" style="padding: 8px 12px;"><div class="h-left"><span class="h-cat" style="font-size:15px; display:flex; align-items:center; gap:5px;">${tx.ticker}<span style="font-size:10px; padding:1px 5px; border-radius:4px; font-weight:bold; ${badgeStyle}">${tx.action}</span></span><span class="h-date">${tx.date}</span></div><div class="h-right"><div class="h-amt sensitive" style="font-size:14px; color:var(--text-main);">‚Ç¨ ${tx.eur.toFixed(2)}</div>${tx.fx > 0 ? `<div style="font-size:10px; color:var(--gray);">${tx.fx.toFixed(2)} (FX)</div>` : ''}<div style="display:flex; justify-content:flex-end; margin-top:2px;"><span class="h-del" style="font-size:12px;" onclick="deleteTx('${tx.sheet}', ${tx.row})">üóëÔ∏è</span></div></div></div>`;
      });
      container.innerHTML = html;
  };
  renderList(data.stocks, 'hist-stocks'); 
  renderList(data.crypto, 'hist-crypto');
}

function getActionStyle(action) {
  let a = String(action).toLowerCase();
  if (a === 'buy') return 'background:var(--stocks-bg); color:white;';
  if (a === 'sell') return 'background:var(--danger); color:white;';
  if (a === 'deposit') return 'background:#ffc107; color:black;';
  if (a === 'dividend') return 'background:var(--primary); color:white;';
  return 'background:var(--gray); color:white;';
}

// --- Investment Search ---

function openInvestSearch() {
  closeAllSheets();
  const sheet = document.getElementById('invest-search-sheet'); 
  const backdrop = document.getElementById('common-backdrop');
  document.getElementById('invSearchQuery').value = ''; 
  document.getElementById('invSearchResults').innerHTML = '<div style="text-align:center; color:var(--gray); margin-top:20px;">Search portfolio...</div>';
  sheet.classList.add('active'); 
  backdrop.classList.add('active');
  
  const yearSelect = document.getElementById('invSearchYear');
  if (yearSelect.options.length <= 1) { 
      google.script.run.withSuccessHandler(years => { 
          yearSelect.innerHTML = '<option value="">All Years</option>'; 
          years.forEach(y => { 
              let opt = document.createElement('option'); 
              opt.value = y; 
              opt.text = y; 
              yearSelect.add(opt); 
          }); 
      }).getInvestmentYears(); 
  }
}

function performInvestSearch() {
  const query = document.getElementById('invSearchQuery').value; 
  const type = document.getElementById('invSearchType').value; 
  const year = document.getElementById('invSearchYear').value; 
  const resCont = document.getElementById('invSearchResults');
  
  resCont.innerHTML = '<div style="text-align:center; color:var(--gray); margin-top:20px;">Searching History...</div>';
  
  google.script.run.withSuccessHandler(results => {
      if (results.length === 0) { 
          resCont.innerHTML = '<div style="text-align:center; color:var(--gray); margin-top:20px;">No investment found</div>'; 
          return; 
      }
      let html = '';
      results.forEach(r => {
          let badgeStyle = getActionStyle(r.action);
          html += `<div class="search-res-item"><div class="sr-left"><span class="sr-cat" style="display:flex; align-items:center; gap:5px;">${r.ticker} <span style="font-size:9px; padding:1px 4px; border-radius:3px; ${badgeStyle}">${r.action}</span></span><span class="sr-note" style="color:var(--gray); font-weight:500;">Qty: ${r.qty}</span><span class="sr-date">${r.date}</span></div><div class="sr-right" style="text-align:right;"><div class="sr-amt sensitive" style="color:var(--text-main);">‚Ç¨ ${r.eur.toFixed(2)}</div>${r.forex > 0 ? `<div style="font-size:10px; color:var(--gray);">${r.forex.toFixed(2)} (FX)</div>` : ''}</div></div>`;
      });
      resCont.innerHTML = html;
  }).searchInvestHistory(query, type, year);
}
</script>